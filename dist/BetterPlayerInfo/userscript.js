// ==UserScript==
// @name         BetterPlayerInfo
// @namespace    https://github.com/LegendaryB/tw-userscripts
// @version      0.1
// @author       LegendaryB
// @include      https://de*.die-staemme.de/game.php?*screen=info_player*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=die-staemme.de
// @grant        none
// ==/UserScript==

(()=>{"use strict";class e{static InfoMessage(e){window.UI.InfoMessage(e)}static SuccessMessage(e){window.UI.SuccessMessage(e)}static ErrorMessage(e){window.UI.ErrorMessage(e)}}var t,a;class l{static registerTranslationProvider(e,t){this.translationProviderMap.set(e,t)}static unregisterTranslationProvider(e){this.translationProviderMap.delete(e)}static getPropertyKeyByHandlebar(e){return e.replace("{{","").replace("}}","")}}t=l,l.translationProviderMap=new Map,l.translate=e=>{let a=t.translationProviderMap.get(window.game_data.locale);return a?a[e]:"ERROR! NO TRANSLATION!"},l.translateAndReplace=e=>{let a=e.match(/{{{?(#[a-z]+ )?[a-z]+.[a-z]*}?}}/gi);if(!a)return e;for(const l of a){let a=t.getPropertyKeyByHandlebar(l),n=t.translate(a);e=e.replace(l,n)}return e},new l,window.game_data.world;class n{static getPlayerInfoTable(){let e=document.getElementById("player_info"),t=e.rows[2],a=e.rows[3],l=e.rows[4],n=5;document.querySelector('[src*="/premium/features/Premium_small.png"]')&&(n=6);let r=e.rows[n];return{Points:{Value:t.cells[1].innerText,Element:t},Rank:{Value:a.cells[1].innerText,Element:a},Bashpoints:{Value:l.cells[1].innerText,Element:l},Tribe:{Value:r.cells[1].innerText,Element:r},Element:e}}static getVillageTable(){let e=document.getElementById("villages_list");return{Header:this.getVillageTableHeader(e),Rows:this.getVillageTableRows(e),Element:e}}static getVillageTableHeader(e){let t=e.tHead,a=t.rows[0];return{Name:{Value:a.cells[0].innerText,Element:a.cells[0]},Coordinates:{Value:a.cells[1].innerText,Element:a.cells[1]},Points:{Value:a.cells[2].innerText,Element:a.cells[2]},Element:t}}static getVillageTableRows(e){let t=[];for(const a of e.tBodies[0].rows)t.push({Name:a.cells[0].innerText,Coordinates:a.cells[1].innerText,Points:Number(a.cells[2].innerText.replaceAll(".","")),Element:a});return t}}class r{}a=r,r.ELEMENT_ID="BetterPlayerInfo_CopyVillageCoordinates",r.populateTemplate=e=>`\n        <a id="${a.ELEMENT_ID}" style="cursor: pointer;" title="Click to copy all &#10;&#13;village coordinates">${e}</a>\n    `;class s{static attach(e){const t=e.Header.Coordinates.Element,a=t.innerText;t.innerHTML=r.populateTemplate(a),document.getElementById(r.ELEMENT_ID).onclick=async()=>await this.handleElementClick(e.Rows)}static async handleElementClick(t){let a=[];for(const e of t){let t=e.Coordinates;a.push(t)}await navigator.clipboard.writeText(a.join("\n")),e.SuccessMessage("Village coordinates copied to clipboard!")}}const i=async(e,t)=>{try{let a=`/game.php?screen=ranking&mode=in_a_day&type=${t}&name=${encodeURIComponent(e)}`,l=(await(async e=>{try{let t=await fetch(e),a=await t.text();return(new DOMParser).parseFromString(a,"text/html")}catch(e){return}})(a)).getElementById("in_a_day_ranking_table").querySelector("[class=userimage-tiny]").closest("tr");return{Rank:l.cells[0].innerText,Points:Number(l.cells[3].innerText.replace(".",""))}}catch(e){return 0}};class o{}o.populateTemplate=(e,t)=>`\n        <tr>\n            <td>${e}:</td>\n            <td>${t}</td>\n        </tr>\n    `;const c=window.InfoPlayer,d=window.game_data;class m{static async attach(e){let t=document.querySelector("h2").innerText;c.player_id==d.player.player_id&&(t=d.player.name);let a=await i(t,"loot_res"),l=await i(t,"scavenge"),n=e.Bashpoints.Element,r=o.populateTemplate("Farm",`${a.Points.toLocaleString()} (${a.Rank}.)`),s=o.populateTemplate("Raubzug",`${l.Points.toLocaleString()} (${l.Rank}.)`);n.insertAdjacentHTML("afterend",r),n.insertAdjacentHTML("afterend",s)}}(async()=>{const e=n.getPlayerInfoTable(),t=n.getVillageTable();s.attach(t),await m.attach(e)})()})();