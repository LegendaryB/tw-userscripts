// ==UserScript==
// @name         BetterPlayerInfo
// @namespace    https://github.com/LegendaryB/tw-userscripts
// @version      0.1
// @author       LegendaryB
// @include      https://de*.die-staemme.de/game.php?*screen=info_player*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=die-staemme.de
// @grant        none
// ==/UserScript==

(()=>{"use strict";class e{static InfoMessage(e){window.UI.InfoMessage(e)}static SuccessMessage(e){window.UI.SuccessMessage(e)}static ErrorMessage(e){window.UI.ErrorMessage(e)}}var t,a;class n{static registerTranslationProvider(e,t){this.translationProviderMap.set(e,t)}static unregisterTranslationProvider(e){this.translationProviderMap.delete(e)}static getPropertyKeyByHandlebar(e){return e.replace("{{","").replace("}}","")}}t=n,n.translationProviderMap=new Map,n.translate=e=>{let a=t.translationProviderMap.get(window.game_data.locale);return a?a[e]:"ERROR! NO TRANSLATION!"},n.translateAndReplace=e=>{let a=e.match(/{{{?(#[a-z]+ )?[a-z]+.[a-z]*}?}}/gi);if(!a)return e;for(const n of a){let a=t.getPropertyKeyByHandlebar(n),l=t.translate(a);e=e.replace(n,l)}return e},new n,window.game_data.world;class l{static getPlayerInfoTable(){let e=document.getElementById("player_info"),t=e.rows[2],a=e.rows[3],n=e.rows[4],l=5;document.querySelector('[src*="/premium/features/Premium_small.png"]')&&(l=6);let r=e.rows[l];return{Points:{Value:t.cells[1].innerText,Element:t},Rank:{Value:a.cells[1].innerText,Element:a},Bashpoints:{Value:n.cells[1].innerText,Element:n},Tribe:{Value:r.cells[1].innerText,Element:r},Element:e}}static getVillageTable(){let e=document.getElementById("villages_list");return{Header:this.getVillageTableHeader(e),Rows:this.getVillageTableRows(e),Element:e}}static getVillageTableHeader(e){let t=e.tHead,a=t.rows[0];return{Name:{Value:a.cells[0].innerText,Element:a.cells[0]},Coordinates:{Value:a.cells[1].innerText,Element:a.cells[1]},Points:{Value:a.cells[2].innerText,Element:a.cells[2]},Element:t}}static getVillageTableRows(e){let t=[];for(const a of e.tBodies[0].rows)t.push({Name:a.cells[0].innerText,Coordinates:a.cells[1].innerText,Points:Number(a.cells[2].innerText.replaceAll(".","")),Element:a});return t}}class r{}a=r,r.ELEMENT_ID="BetterPlayerInfo_CopyVillageCoordinates",r.populateTemplate=e=>`\n        <a id="${a.ELEMENT_ID}" style="cursor: pointer;" title="Click to copy all &#10;&#13;village coordinates">${e}</a>\n    `;class s{static attach(e){const t=e.Header.Coordinates.Element,a=t.innerText;t.innerHTML=r.populateTemplate(a),document.getElementById(r.ELEMENT_ID).onclick=async()=>await this.handleElementClick(e.Rows)}static async handleElementClick(t){let a=[];for(const e of t){let t=e.Coordinates;a.push(t)}await navigator.clipboard.writeText(a.join("\n")),e.SuccessMessage("Village coordinates copied to clipboard!")}}const i=async(e,t)=>{try{let a=`/game.php?screen=ranking&mode=in_a_day&type=${t}&name=${encodeURIComponent(e)}`,n=(await(async e=>{try{let t=await fetch(e),a=await t.text();return(new DOMParser).parseFromString(a,"text/html")}catch(e){return}})(a)).getElementById("in_a_day_ranking_table").querySelector("[class=userimage-tiny]").closest("tr");return{Rank:n.cells[0].innerText,Points:Number(n.cells[3].innerText.replace(".",""))}}catch(e){return 0}};class o{}o.populateTemplate=(e,t)=>`\n        <tr>\n            <td>${e}:</td>\n            <td>${t}</td>\n        </tr>\n    `;class c{static async attach(e){let t=document.querySelector("h2").innerText,a=await i(t,"loot_res"),n=await i(t,"scavenge"),l=e.Bashpoints.Element,r=o.populateTemplate("Farm",`${a.Points.toLocaleString()} (${a.Rank}.)`),s=o.populateTemplate("Raubzug",`${n.Points.toLocaleString()} (${n.Rank}.)`);l.insertAdjacentHTML("afterend",r),l.insertAdjacentHTML("afterend",s)}}(async()=>{const e=l.getPlayerInfoTable(),t=l.getVillageTable();s.attach(t),await c.attach(e)})()})();