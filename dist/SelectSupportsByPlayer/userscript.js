// ==UserScript==
// @name         Select supports by player
// @namespace    https://github.com/LegendaryB/tw-userscripts
// @version      0.1
// @author       LegendaryB
// @match		 https://*.die-staemme.de/game.php*screen=place*&mode=units*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=die-staemme.de
// @grant        none
// ==/UserScript==

(()=>{"use strict";var e,t,n,r,a,o,l,s={},i={};function c(e){var t=i[e];if(void 0!==t)return t.exports;var n=i[e]={exports:{}};return s[e](n,n.exports,c),n.exports}t=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,c.t=function(n,r){if(1&r&&(n=this(n)),8&r)return n;if("object"==typeof n&&n){if(4&r&&n.__esModule)return n;if(16&r&&"function"==typeof n.then)return n}var a=Object.create(null);c.r(a);var o={};e=e||[null,t({}),t([]),t(t)];for(var l=2&r&&n;"object"==typeof l&&!~e.indexOf(l);l=t(l))Object.getOwnPropertyNames(l).forEach((e=>o[e]=()=>n[e]));return o.default=()=>n,c.d(a,o),a},c.d=(e,t)=>{for(var n in t)c.o(t,n)&&!c.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},c.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),c.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n||(n={}),function(e){e[e.Unit=0]="Unit",e[e.Building=1]="Building"}(r||(r={})),function(e){e[e.Spear=0]="Spear",e[e.Sword=1]="Sword",e[e.Axe=2]="Axe",e[e.Spy=3]="Spy",e[e.Light=4]="Light",e[e.Heavy=5]="Heavy",e[e.Ram=6]="Ram",e[e.Catapult=7]="Catapult",e[e.Snob=8]="Snob",e[e.Knight=9]="Knight"}(a||(a={}));class p{static getBuildingIcon(e){let t=n[e].toString();return this.getIcon(t,r.Unit)}static getUnitIcon(e){let t=a[e].toLowerCase();return this.getIcon(`unit_${t}`,r.Unit)}static getIcon(e,t){return`${window.location.origin}/${this.iconAssetTypeToPathMap.get(t)}/${e}.png`}}o=p,p.iconAssetTypeToPathMap=new Map,p.basePath="/graphic",o.iconAssetTypeToPathMap.set(r.Building,`${o.basePath}/buildings`),o.iconAssetTypeToPathMap.set(r.Unit,`${o.basePath}/unit`);class u{static getDefenceTable(){return document.getElementById("units_home")}static getDefenceTableRows(){const e=this.getDefenceTableRowElements();let t=[];for(const n of e){const e=this.getDefenceTableRowData(n);t.push({element:n,data:e})}return t}static getDefenceTableRowData(e){let t=new Map,n=Array.from(e.querySelectorAll(".unit-item"));for(const e of n){let n=this.getUnitName(e),r=Number(e.innerText);t.set(n,r)}return{source:e.cells[1].innerText,playerName:this.getPlayerName(e),distance:Number(e.cells[2].innerText),units:t}}static getDefenceTableRowElements(){let e=this.getDefenceTable(),t=Array.from(e.querySelectorAll("input[type=checkbox]:not(.selectAll)")),n=[];for(const e of t){let t=e.closest("tr");null!==t&&n.push(t)}return n}static getUnitName(e){const t="unit-item-";let n=Array.from(e.classList);for(const e of n)if(-1!=e.indexOf(t)){let n=e;return n=n.replace(t,""),n=this.toUpperCaseAt(n,0),n}return null}static getPlayerName(e){return e.cells[1].innerText.match(/\(([^()]*)\)/g)[0].replace("(","").replace(")","")}static toUpperCaseAt(e,t){return e.substring(0,t)+e.charAt(t).toUpperCase()+e.substring(t+1)}}!function(e){e[e.Info=0]="Info",e[e.Success=1]="Success",e[e.Error=2]="Error"}(l||(l={}));class d{static showInfoMessage(e){this.showMessage(e,l.Info)}static showSuccessMessage(e){this.showMessage(e,l.Success)}static showErrorMessage(e){this.showMessage(e,l.Error)}static showMessage(e,t){switch(t){case l.Info:window.UI.InfoMessage(e);break;case l.Success:window.UI.SuccessMessage(e);break;case l.Error:window.UI.ErrorMessage(e)}}}const g=e=>{let t=document.createElement("template");return t.innerHTML=e.trim(),t.content.firstChild};var y;class f{static registerTranslationProvider(e,t){this.translationProviderMap.set(e,t)}static unregisterTranslationProvider(e){this.translationProviderMap.delete(e)}static getPropertyKeyByHandlebar(e){return e.replace("{{","").replace("}}","")}}y=f,f.translationProviderMap=new Map,f.translate=e=>{let t=y.translationProviderMap.get(navigator.language);return t=t||y.translationProviderMap.en,t[e]},f.translateAndReplace=e=>{let t=e.match(/{{{?(#[a-z]+ )?[a-z]+.[a-z]*}?}}/gi);if(!t)return e;for(const n of t){let t=y.getPropertyKeyByHandlebar(n),r=y.translate(t);e=e.replace(n,r)}return e},new f;const h="SelectSupportsByPlayer",b=`${h}_playerNameSelection`,m=`${h}_filterTable`,v=`${h}_applyFilterBtn`,S=`${h}_filterRow_%UNIT%`,U=`${S}_Operand`,w=`${S}_Value`,A=`\n        <div>\n            <div>\n                <h4 style="font-style: normal;">{{Header}}</h4>\n                <select>\n                    <option value=""></option>\n                    <option value="No Game No Life">No Game No Life</option>\n                </select>\n                <div id="${b}"></div>\n            </div>\n\n            <div>\n                <div style="margin: 16px 0px 16px 0px;">\n                    <table id="${m}">\n                        <tbody>\n                            <tr id="${h}_filterTableHeader">\n                                <th colspan="2">{{FilterHeader}}</th>\n                            </tr>\n                        </tbody>\n                    </table>\n\n                    <table align="left">\n                        <tbody>\n                            <tr>\n                                <td>\n                                    <input id="${v}" class="btn" type="submit" value="{{FilterApplyButton}}">\n                                </td>\n                            </tr>\n                        </tbody>\n                    </table>\n                </div>\n            </div>\n\n        </div>`,T=`\n        <tr id="%UNIT%">\n            <td>\n                <label>\n                    <input type="checkbox">\n                    {{Unit%UNIT%}}\n                </label>\n            </td>\n            <td>\n                <select id="${U}">\n                    <option value=">">&gt;</option>\n                    <option value="<">&lt;</option>\n                    <option value="=">=</option>\n                    <option value=">=">>=</option>\n                    <option value="<="><=</option>\n                    <option value="!=">!=</option>\n                </select>\n                <input id="${w}" type="number"> \n            </td>\n        </tr>\n`,P=e=>{let t=g('<a style="cursor: pointer;" target="_self"></a>');return t.innerText=e,t};class M{}const I=e=>{let t=new M;t.Unit=e.id;let n=e.querySelector(`#${U.replace("%UNIT%",t.Unit)}`),r=e.querySelector(`#${w.replace("%UNIT%",t.Unit)}`);return t.Operand=n.value,t.Value=Number(r.value),t},N={"<":(e,t)=>e<t,">":(e,t)=>e>t,"=":(e,t)=>e==t,">=":(e,t)=>e>=t,"<=":(e,t)=>e<=t,"!=":(e,t)=>e!=t},x=(e,t)=>{(()=>{const e=document.getElementById("content_value").querySelector("h3");let t=f.translateAndReplace(A);e.after(g(t))})(),((e,t)=>{const n=document.getElementById(b);let r=[];for(let a=0;a<e.length;a++){let o=e[a],l=o.data.playerName;if(r.includes(l))continue;let s=P(l);s.onclick=()=>t(o),r.push(o.data.playerName),n.appendChild(s)}})(e,t),(e=>{let t=document.getElementById(m).querySelector("tbody");for(const n of e[0].data.units.keys()){let e=T.replaceAll("%UNIT%",n);e=f.translateAndReplace(e);let r=g(e);t.appendChild(r)}document.getElementById(v).onclick=()=>(()=>{let e=(()=>{let e=document.getElementById(m),t=Array.from(e.querySelectorAll('input[type="checkbox"]:checked')).map((e=>e.closest("tr"))),n=[];for(const e of t){let t=I(e);n.push(t)}return n})(),t=u.getDefenceTableRows();(e=>{for(const t of e)"none"==t.element.style.display&&(t.element.style.display="")})(t);for(const n of t)for(const t of e)(0,N[t.Operand])(n.data.units.get(t.Unit),t.Value)||(n.element.style.display="none")})()})(e)},E=JSON.parse('{"Header":"Unterstützungen eines Spielers auswählen","FilterHeader":"Truppen Filter","FilterApplyButton":"Filter anwenden","UnitSpear":"Speer","UnitSword":"Schwert","UnitAxe":"Axt","UnitSpy":"Späher","UnitLight":"Leichte Kavallerie","UnitHeavy":"Schwere Kavallerie","UnitRam":"Rammbock","UnitCatapult":"Katapult","UnitKnight":"Paladin","UnitSnob":"Adelsgeschlecht","SelectionMessage":"Alle Unterstützungen von <b>%PLAYER%</b> <span style=\\"color: green\\">ausgewählt</span>!","DeselectionMessage":"Alle Unterstützungen von <b>%PLAYER%</b> <span style=\\"color: red\\">abgewählt</span>!"}');var R=c.t(E,2);const $=JSON.parse('{"Header":"Select supports of player","FilterHeader":"Unit Filter","FilterApplyButton":"Apply filter","UnitSpear":"Spear","UnitSword":"Sword","UnitAxe":"Axe","UnitSpy":"Spy","UnitLight":"Light","UnitHeavy":"Heavy","UnitRam":"Ram","UnitCatapult":"Catapult","UnitKnight":"Knight","UnitSnob":"Snob","SelectionMessage":"All supports of <b>%PLAYER%</b> <span style=\\"color: green\\">selected</span>!","DeselectionMessage":"All supports of <b>%PLAYER%</b> <span style=\\"color: red\\">unselected</span>!"}');var _=c.t($,2);(()=>{f.registerTranslationProvider("en",_),f.registerTranslationProvider("de",R);const e=(e,t)=>{let n=f.translate("SelectionMessage").replace("%PLAYER%",e);for(const r of t){if(""!=r.element.style.display)continue;let t=r.element.firstElementChild.firstElementChild;r.data.playerName==e?(t.checked=!t.checked,t.checked||(n=f.translate("DeselectionMessage").replace("%PLAYER%",e))):t.checked=!1}d.showInfoMessage(n)};let t=u.getDefenceTableRows();0!=t.length&&x(t,(n=>e(n.data.playerName,t)))})()})();