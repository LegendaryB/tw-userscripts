// ==UserScript==
// @name         CountOwnSupport
// @author       LegendaryB
// @namespace    https://github.com/LegendaryB/tw-userscripts
// @version      0.1
// @include      https://de*.die-staemme.de/game.php?village=*&screen=info_village*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=die-staemme.de
// @downloadURL  https://github.com/LegendaryB/tw-userscripts/raw/main/dist/CountOwnSupport/CountOwnSupport.user.js
// @updateURL    https://github.com/LegendaryB/tw-userscripts/raw/main/dist/CountOwnSupport/CountOwnSupport.user.js
// @grant        none
// ==/UserScript==

(()=>{"use strict";class e{static InfoMessage(e){window.UI.InfoMessage(e)}static SuccessMessage(e){window.UI.SuccessMessage(e)}static ErrorMessage(e){window.UI.ErrorMessage(e)}}var t;class n{static registerTranslationProvider(e,t){this.translationProviderMap.set(e,t)}static unregisterTranslationProvider(e){this.translationProviderMap.delete(e)}static getPropertyKeyByHandlebar(e){return e.replace("{{","").replace("}}","")}}t=n,n.translationProviderMap=new Map,n.translate=e=>{let n=t.translationProviderMap.get(window.game_data.locale);return n?n[e]:"ERROR! NO TRANSLATION!"},n.translateAndReplace=e=>{let n=e.match(/{{{?(#[a-z]+ )?[a-z]+.[a-z]*}?}}/gi);if(!n)return e;for(const r of n){let n=t.getPropertyKeyByHandlebar(r),a=t.translate(n);e=e.replace(r,a)}return e},new n,window.game_data.world;const r=e=>new Promise((t=>setTimeout(t,e)));(async()=>{const t="CountOwnSupportsRow",n=async()=>{const n=await(async()=>{const e=document.querySelectorAll("[class=command_hover_details][data-command-type=support]");let t={};for(let n of e){let e=n.closest("tr").querySelector(".quickedit-label"),a=n.getAttribute("data-command-id"),o=`/game.php?village=${window.game_data.village.id}&screen=info_command&ajax=details&id=${a}`;const s=await fetch(o),c=await s.json();for(const e in c.units)t[e]=t[e]||0,t[e]+=Number(c.units[e].count);e.style.color="green",await r(Math.floor(50*Math.random()+200))}return t})();if(0===Object.entries(n).length)return void e.ErrorMessage("Keine ausgehende Unterstützung gefunden!");const a=(()=>{document.getElementById(t)?.remove();const e=document.querySelector("#support_sum").querySelector("tbody");let n=e.querySelector("tr").cloneNode(!0);n.id=t,e.appendChild(n);const r=document.getElementById(t);for(const e of r.cells)e.innerHTML="0";return r})();for(const[e,t]of Object.entries(n)){const n=`[data-unit="${e}"]`,r=a.querySelector(n);r&&(r.innerHTML=t.toString(),r.style.backgroundColor="#AFE1AF")}let o=a.querySelector('[data-unit="pop"]');o.innerHTML="0",o.style.backgroundColor="#AFE1AF"};document.querySelector("#commands_outgoings")&&(document.querySelector(".action-icon-container").closest("tr").insertAdjacentHTML("afterend",'\n        <tr>\n            <td colspan="2">\n                <a id="CountOwnSupportBtn" href="javascript:;">\n                    <span class="action-icon-container">\n                        <span class="icon header troops"></span>\n                    </span>\n                    Eigene Unterstützung zählen\n                </a>\n            </td>\n        </tr>'),document.querySelector("#CountOwnSupportBtn").onclick=async()=>await n())})()})();