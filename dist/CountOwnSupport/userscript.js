// ==UserScript==
// @name         CountOwnSupport
// @namespace    https://github.com/LegendaryB/tw-userscripts
// @version      0.1
// @author       LegendaryB
// @include      https://de*.die-staemme.de/game.php?village=*&screen=info_village*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=die-staemme.de
// @grant        none
// ==/UserScript==

(()=>{"use strict";var e;class t{static registerTranslationProvider(e,t){this.translationProviderMap.set(e,t)}static unregisterTranslationProvider(e){this.translationProviderMap.delete(e)}static getPropertyKeyByHandlebar(e){return e.replace("{{","").replace("}}","")}}e=t,t.translationProviderMap=new Map,t.translate=t=>{let r=e.translationProviderMap.get(window.game_data.locale);return r?r[t]:"ERROR! NO TRANSLATION!"},t.translateAndReplace=t=>{let r=t.match(/{{{?(#[a-z]+ )?[a-z]+.[a-z]*}?}}/gi);if(!r)return t;for(const o of r){let r=e.getPropertyKeyByHandlebar(o),n=e.translate(r);t=t.replace(o,n)}return t},new t,window.game_data.world;const r=e=>new Promise((t=>setTimeout(t,e)));(async()=>{const e="CountOwnSupportsRow",t="CountOwnSupportBtn",o=`<button id="${t}" class="btn">Eigene z√§hlen</button>`,n=document.querySelector("#commands_outgoings");n&&(n.querySelector("table").querySelector("th").insertAdjacentHTML("beforeend",o),document.querySelector(`#${t}`).onclick=async()=>await(async()=>{const t=(()=>{document.getElementById(e)?.remove();const t=document.querySelector("#support_sum").querySelector("tbody");let r=t.querySelector("tr").cloneNode(!0);r.id=e,t.appendChild(r);const o=document.getElementById(e);for(const e of o.cells)e.innerHTML="0";return o})(),o=await(async()=>{const e=document.querySelectorAll("[class=command_hover_details][data-command-type=support]");let t={};for(let o of e){let e=o.closest("tr").querySelector(".quickedit-label"),n=o.getAttribute("data-command-id"),a=`/game.php?village=${window.game_data.village.id}&screen=info_command&ajax=details&id=${n}`;const l=await fetch(a),c=await l.json();for(const e in c.units)t[e]=t[e]||0,t[e]+=Number(c.units[e].count);e.style.color="green",await r(Math.floor(50*Math.random()+200))}return t})();for(const[e,r]of Object.entries(o)){const o=`[data-unit="${e}"]`,n=t.querySelector(o);n&&(n.innerHTML=r.toString(),n.style.backgroundColor="#AFE1AF")}let n=t.querySelector('[data-unit="pop"]');n.innerHTML="0",n.style.backgroundColor="#AFE1AF"})())})()})();