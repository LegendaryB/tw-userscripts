// ==UserScript==
// @name         Village Distance Calculator
// @namespace    https://github.com/LegendaryB/tw-userscripts
// @version      0.4
// @author       LegendaryB
// @include		 https://de*.die-staemme.de/game.php*screen=map*
// @require      https://raw.githubusercontent.com/LegendaryB/tw-framework/main/dist/framework.js
// @icon         https://www.google.com/s2/favicons?sz=64&domain=die-staemme.de
// @grant        none
// ==/UserScript==

(()=>{"use strict";class e{static InfoMessage(e){window.UI.InfoMessage(e)}static SuccessMessage(e){window.UI.SuccessMessage(e)}static ErrorMessage(e){window.UI.ErrorMessage(e)}}var t;class n{static registerTranslationProvider(e,t){this.translationProviderMap.set(e,t)}static unregisterTranslationProvider(e){this.translationProviderMap.delete(e)}static getPropertyKeyByHandlebar(e){return e.replace("{{","").replace("}}","")}}t=n,n.translationProviderMap=new Map,n.translate=e=>{let n=t.translationProviderMap.get(window.game_data.locale);return n?n[e]:"ERROR! NO TRANSLATION!"},n.translateAndReplace=e=>{let n=e.match(/{{{?(#[a-z]+ )?[a-z]+.[a-z]*}?}}/gi);if(!n)return e;for(const a of n){let n=t.getPropertyKeyByHandlebar(a),r=t.translate(n);e=e.replace(a,r)}return e},new n;const a=`tw-framework_${window.game_data.world}`;class r{static getItem(e){return e=this.makeKey(e),localStorage.getItem(e)}static setItem(e,t){e=this.makeKey(e),localStorage.setItem(e,t)}static setRawItem(e,t){e=this.makeKey(e);let n=JSON.stringify(t);localStorage.setItem(e,n)}static removeItem(e){e=this.makeKey(e),localStorage.removeItem(e)}static makeKey(e){return`${a}_${e}`}}const i=(e,t)=>e.substring(0,t)+e.charAt(t).toUpperCase()+e.substr(t+1),l=e=>{let t=((e,t)=>{let n=[],a=-1;for(;(a=e.indexOf("_",a+1))>=0;)n.push(a);return n})(e);e=i(e,0);for(const n of t)e=i(e,n+1);return e.replaceAll("_","")};var o=function(e,t,n,a){return new(n||(n=Promise))((function(r,i){function l(e){try{s(a.next(e))}catch(e){i(e)}}function o(e){try{s(a.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(l,o)}s((a=a.apply(e,t||[])).next())}))};const s=(e,t,n)=>{let a=((e,t)=>{let n=e.xy.toString(),a=t.xy.toString();return((e,t,n,a)=>{let r=e-n,i=t-a;return Math.sqrt(r*r+i*i)})(Number(n.slice(0,3)),Number(n.slice(3,6)),Number(a.slice(0,3)),Number(a.slice(3,6)))})(e,t);return((e,t)=>e*t)(a,n.Speed)},c=window.TWMap,d=c.mapHandler;let u=!1,g=[];const f=(e,t)=>{let n=`\n    <div class="SelectionIndicator" id="SelectionIndicator_${e.id}"\n        style="outline: 2px dashed gold; width:52px; height:37px; position: absolute; z-index: 50; left: ${t.style.left}; top: ${t.style.top};">\n    </div>\n`;t.insertAdjacentHTML("afterend",n)},m=e=>{const t=document.getElementById("VillageDistanceCalculatorHeaders"),n=`\n    <th style="text-align: center;">\n        <a href="#" class="unit_link"> <img src="https://dsde.innogamescdn.com/asset/f6f54c14/graphic/unit/unit_${e.toLowerCase()}.png"/></a>\n    </th>\n`;t.insertAdjacentHTML("beforeend",n)},p=(e,t)=>{const n=document.getElementById("VillageDistanceCalculatorBody"),a=((e,t)=>`\n    <td style="text-align: center;" data-unit="${e}">${t}</td>\n`)(e.toLowerCase(),t);n.insertAdjacentHTML("beforeend",a)},y=async()=>{const e=await o(void 0,void 0,void 0,(function*(){let e=yield(t="interface.php?func=get_unit_info",n="unitInfo",o(void 0,void 0,void 0,(function*(){let e=r.getItem(n);if(e)return JSON.parse(e);let a=yield(e=>o(void 0,void 0,void 0,(function*(){let t=`${new URL(window.location.origin)}/${e}`,n=yield fetch(t);return yield n.text()})))(t),s=(e=>{let t={},n=(new DOMParser).parseFromString(e,"text/xml").querySelector("config");for(const e of n.children){let n=l(i(e.localName,0));if(t[n]={},0!=e.children.length)for(const a of e.children){let e=l(a.localName);t[n][e]=Number(a.innerHTML)}else t[n]=Number(e.innerHTML)}return t})(a);return r.setRawItem(n,s),s})));var t,n;return delete e.Militia,e})),t=g[0],n=g[1];document.getElementById("map_whole").insertAdjacentHTML("afterend",'\n    <table id="VillageDistanceCalculatorTable" class="vis" style="border-spacing: 0px; border-collapse: collapse; table-layout: fixed;" width="100%">\n        <thead>\n            <tr id="VillageDistanceCalculatorHeaders">\n            </tr>\n        </thead>\n        <tbody>\n            <tr id="VillageDistanceCalculatorBody">\n            </tr>\n        </tbody>\n    </table>\n');for(const a in e){const r=s(t,n,e[a]);m(a),p(a,S(r))}},h=(e,t)=>{d.integratedSpawnSector(e,t);for(const e of g){let t=document.getElementById(`map_village_${e.id}`);t&&f(e,t)}},w=(t,n,a)=>((async(t,n)=>{let a=c.villages[1e3*t+n];if(!a)return;2==g.length&&v(),e.SuccessMessage(`Selected village: ${t}|${n}`);let r=g.findIndex((e=>e.id==a.id));-1!=r?g.splice(r,1):g.push(a),c.reload(),2==g.length&&await y()})(t,n),!1),v=()=>{g=[],M(),c.reload()},M=()=>{let e=document.getElementById("VillageDistanceCalculatorTable");e&&e.remove()},I=e=>e<10?`0${e}`:e,S=e=>{let t=Math.round(60*e),n=t%60,a=Math.floor(t/60),r=a%60,i=Math.floor(a/60),l=i%24,o=Math.floor(i/24);return o>0&&(l+=24*o),`${I(l)}:${I(r)}:${I(n)}`};document.addEventListener("keydown",(t=>{(t.isComposing||"d"===t.key)&&(u?(e.InfoMessage("VillageDistanceCalculator inactive"),u=!1,d.spawnSector=d.integratedSpawnSector,d.onClick=d.integratedClickFunction,v()):(e.InfoMessage("VillageDistanceCalculator active"),u=!0,d.integratedSpawnSector=d.spawnSector,d.spawnSector=h,d.integratedClickFunction=d.onClick,d.onClick=w,c.reload()))}))})();